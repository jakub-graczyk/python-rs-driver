name: CI

on:
    push:
        branches:
            - "**"
    pull_request:
    workflow_dispatch:

permissions:
    contents: read

env:
    SCYLLA_URI: "127.0.0.2:9042"
    SCYLLA_URI2: "127.0.0.3:9042"
    SCYLLA_URI3: "127.0.0.4:9042"

jobs:
    static-checks:
        name: Static Checks
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"

            - name: Set up Python
              run: uv python install 3.12

            - name: Install Python dependencies
              run: uv sync --dev

            - name: Run static checks
              run: make static

    smoke-tests:
        name: Smoke Tests
        runs-on: ubuntu-latest
        needs: static-checks
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"

            - name: Set up Python
              run: uv python install 3.12

            - name: Install Python dependencies
              run: uv sync --dev

            - name: Start ScyllaDB cluster
              run: make up

            - name: Wait for cluster to be ready
              run: sleep 5

            - name: Run smoke tests
              run: make smoke

            - name: Stop and cleanup ScyllaDB cluster
              if: always()
              run: |
                  make down
                  docker system prune -af --volumes

    all-checks-pass:
        name: All Checks Pass
        needs: [static-checks, smoke-tests]
        runs-on: ubuntu-latest
        steps:
            - run: echo "All checks passed!"
